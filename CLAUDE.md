# CLAUDE.md - YouTube Video Transcriptor Service

## Overview
This service handles YouTube video transcription as part of the larger RAG Widget application. It runs in Kubernetes and processes videos via Google Cloud Pub/Sub messages.

## Active Files in Production

### Core Processing Files
1. **cloud-vm-processor.py** - Main service entry point
   - Listens to Pub/Sub subscription
   - Orchestrates the entire transcription pipeline
   - Handles progress reporting and error management

2. **yt-dlp-aduio-processor-v1.py** - YouTube downloader
   - Downloads videos from YouTube URLs
   - Extracts audio in MP3 format
   - Saves video metadata

3. **transcribe-whisper-replicate.py** - Transcription handler
   - Sends audio chunks to Replicate API
   - Processes Whisper model responses
   - Handles both OpenAI and Fast Whisper models

### Docker Configuration
- **Dockerfile** - Production container (971MB optimized)
- **requirements.txt** - Core Python dependencies
- **replicate-requirements.txt** - Replicate API client

### Unused/Development Files
The following files are NOT used in production:
- direct-transcribe.py (local testing)
- download-youtube-video.py (standalone downloader)
- mini_audio_server.py (development server)
- debug-replicate.py (API testing)
- monitor-progress.py (manual monitoring)

## Production Architecture

### Message Flow
```
1. Receive Pub/Sub message with video URL
2. Download video → Extract audio (MP3)
3. Split audio into 5-minute chunks (WAV format)
4. Upload chunks to GCS bucket
5. Send each chunk to Replicate Whisper API
6. Combine transcription results
7. Upload final transcript to GCS
8. Publish progress updates at each step
9. Clean up temporary files
```

### GCP Resources Used

**Pub/Sub Topics**:
- Subscribe to: `video-processing-requests-sub`
- Publish to: `video-processing-progress`

**Cloud Storage Buckets**:
- `rag-widget-audio-chunks` - Temporary audio chunk storage
- `rag-widget-transcription-outputs` - Final transcription JSON files

**Output Format**:
```
gs://rag-widget-transcription-outputs/{message_id}/results/transcript_{youtube_id}.json
```

## GCP Bucket Naming Conventions & File Organization

### Bucket Structure Overview

The transcription service uses **three GCP buckets** with specific naming patterns:

1. **`rag-widget-transcription-outputs`** - Final transcription results (permanent)
2. **`rag-widget-audio-chunks`** - Temporary audio chunks (auto-deleted)
3. **`rag-widget-processing-logs`** - Service logs (optional)

### Directory Structure & Naming Patterns

#### **1. Message ID-Based Directory Names**
The "long integer directory names" you see in buckets are **Google Cloud Pub/Sub message IDs**.

**Source of Directory Names:**
- **Message ID**: Generated by Google Cloud Pub/Sub when a message is published
- **Format**: Usually 16-19 digit integers (e.g., `1234567890123456789`)
- **Purpose**: Provides unique namespace for each video processing job

**Example Directory Structure:**
```
rag-widget-transcription-outputs/
├── 1234567890123456789/           # ← Pub/Sub Message ID
│   └── results/
│       └── transcript_dQw4w9WgXcQ.json  # ← YouTube Video ID
├── 9876543210987654321/           # ← Another Message ID
│   └── results/
│       └── transcript_abc123def456.json
└── 1111222233334444555/
    └── results/
        └── transcript_xyz789pqr123.json
```

#### **2. Transcript File Naming Convention**

**File Name Format**: `transcript_{youtube_video_id}.json`

**Video ID Extraction Process:**
- **YouTube URLs**: `https://www.youtube.com/watch?v=dQw4w9WgXcQ` → `dQw4w9WgXcQ`
- **Short URLs**: `https://youtu.be/dQw4w9WgXcQ` → `dQw4w9WgXcQ`
- **Fallback**: If video ID extraction fails, uses `"result"` as filename

**Code Reference** (cloud-vm-processor.py):
```python
# Line 1236: File name generation
result_file_path = os.path.join(work_dir, f"transcript_{video_info['id'] or 'result'}.json")

# Lines 820-842: Video ID extraction logic
def extract_video_id(video_url):
    if 'youtube.com' in video_url and 'v=' in video_url:
        return video_url.split("v=")[1].split("&")[0]
    elif 'youtu.be' in video_url:
        return urlparse(video_url).path.lstrip('/')
    return None
```

#### **3. Audio Chunk File Naming**

**Temporary Chunks Location**: `rag-widget-audio-chunks/{message_id}/chunks/`

**File Name Pattern**: `audio-chunk-{index:03d}.{extension}`

**Examples:**
- `audio-chunk-000.mp3` (or `.wav`)
- `audio-chunk-001.mp3`
- `audio-chunk-002.mp3`
- etc.

**Code Reference** (cloud-vm-processor.py):
```python
# Line 205: Chunk file naming
chunk_output = os.path.join(chunks_dir, f"audio-chunk-{i:03d}.{output_ext}")
```

#### **4. Complete Directory Structure**

```
rag-widget-transcription-outputs/
└── {message_id}/                    # Pub/Sub Message ID (permanent)
    └── results/
        └── transcript_{video_id}.json  # YouTube Video ID

rag-widget-audio-chunks/
└── {message_id}/                    # Pub/Sub Message ID (temporary)
    └── chunks/
        ├── audio-chunk-000.mp3      # 5-minute chunks
        ├── audio-chunk-001.mp3
        ├── audio-chunk-002.mp3
        └── ...
```

### File Lifecycle & Storage Patterns

#### **Temporary Storage (Auto-Deleted)**
- **Location**: `rag-widget-audio-chunks/{message_id}/chunks/`
- **Files**: Audio chunks (`audio-chunk-000.mp3`, etc.)
- **Lifecycle**: Created during processing, automatically deleted after successful transcription
- **Cleanup Code**: `delete_gcs_chunks()` function (lines 1276-1278)

#### **Permanent Storage**
- **Location**: `rag-widget-transcription-outputs/{message_id}/results/`
- **Files**: Final transcription JSON (`transcript_{video_id}.json`)
- **Lifecycle**: Kept permanently for retrieval by other services
- **Retention**: No automatic deletion (manual cleanup required if needed)

### Message ID to Video ID Relationship

**Traceability Pattern:**
1. **Message ID** (Directory) = Specific processing job instance
2. **Video ID** (Filename) = YouTube video being processed
3. **Relationship**: One message ID can process one video URL

**Example Mapping:**
```
Processing Job: Message ID 1234567890123456789
Video URL: https://www.youtube.com/watch?v=dQw4w9WgXcQ
Result Path: rag-widget-transcription-outputs/1234567890123456789/results/transcript_dQw4w9WgXcQ.json
```

**Benefits of This Pattern:**
- **Unique Isolation**: Each processing job gets its own workspace
- **Concurrent Processing**: Multiple videos can be processed simultaneously
- **Error Isolation**: Failed jobs don't affect other processing jobs
- **Traceability**: Can correlate any transcript back to its original Pub/Sub message
- **Cleanup Safety**: Temporary files are organized by job, making cleanup safe

### Configuration Sources

**Bucket Names Defined In:**
- **Kubernetes ConfigMap**: `gcp-config-transcription.yml`
- **Environment Variables**: `BUCKET_NAME`, `AUDIO_CHUNKS_BUCKET`
- **Code Defaults**: `rag-widget-audio-chunks` (hardcoded fallback)

**Important Note**: There's a configuration mismatch between Kubernetes ConfigMap (`rag-widget-video-processing-temp`) and the actual code (`rag-widget-audio-chunks`). The code uses the correct bucket name.

### Environment Variables
```bash
# Required
PROJECT_ID=rag-widget
SUBSCRIPTION_ID=video-processing-requests-sub
BUCKET_NAME=rag-widget-transcription-outputs
AUDIO_CHUNKS_BUCKET=rag-widget-audio-chunks
REPLICATE_API_TOKEN=<your-token>
GOOGLE_APPLICATION_CREDENTIALS=/var/secrets/google/gcp-sa-key.json

# Optional (with defaults)
MAX_MESSAGES=10                    # Concurrent message processing
CHUNK_LENGTH_SECONDS=300          # 5-minute chunks
MAX_CONCURRENT_UPLOADS=5          # Parallel GCS uploads
MAX_CONCURRENT_TRANSCRIPTIONS=5   # Parallel API calls
DEFAULT_MODEL_TYPE=openai         # or "fast"
USE_WAV_FORMAT=true              # Convert chunks to WAV
TMPDIR=/tmp/transcription        # Writable temp directory
LOG_LEVEL=INFO                   # Logging verbosity
```

### Whisper Models
- **OpenAI Whisper**: `openai/whisper:8099696689d249cf8b122d833c36ac3f75505c666a395ca40ef26f68e7d3d16e`
- **Fast Whisper**: `vaibhavs10/incredibly-fast-whisper:3ab86df6c8f54c11309d4d1f930ac292bad43ace52d10c80d87eb258b3c9f79c`

### Progress Reporting
Progress updates are published with the following structure:
```json
{
  "message_id": "15468824924819867",
  "video_url": "https://www.youtube.com/watch?v=...",
  "video_id": "youtube_video_id",
  "status": "processing|completed|failed",
  "progress_percent": 0-100,
  "current_stage": "download|chunking|uploading|transcription|finalizing|cleanup|completed|error",
  "stage_progress_percent": 0-100,
  "processing_time_seconds": 123,
  "estimated_time_remaining_seconds": 45,
  "timestamp": "2025-07-07T13:50:12.089728Z",
  "error": null
}
```

### Kubernetes Deployment
```bash
# Build optimized image
docker build -t youtube-video-transcriptor:optimized .

# Deploy to cluster
kubectl apply -f kubernetes/youtube-video-transcriptor.yml

# Check status
kubectl logs -l app=youtube-video-transcriptor
kubectl get pods | grep transcriptor
```

### Common Issues & Solutions

1. **Division by zero in Pub/Sub**
   - Set MAX_MESSAGES > 0 (e.g., 10)

2. **No usable temporary directory**
   - Add TMPDIR=/tmp/transcription env var
   - Mount emptyDir volume at /tmp/transcription

3. **Bucket not found**
   - Verify AUDIO_CHUNKS_BUCKET matches existing GCS bucket
   - Check service account permissions

4. **Transcription not starting**
   - Verify REPLICATE_API_TOKEN is set
   - Check Replicate API quota/billing

5. **Progress not updating in UI**
   - Ensure API service has GCP_PUBSUB_STATUS_TOPIC env var
   - Check videoProcStatusSubscriber is running

### Local Development
```bash
# Setup virtual environment
python3 -m venv venv
source venv/bin/activate
pip install -r requirements.txt -r replicate-requirements.txt

# Set environment variables
export PROJECT_ID=rag-widget
export SUBSCRIPTION_ID=video-processing-requests-sub
# ... (set all required vars)

# Run locally
python cloud-vm-processor.py

# Test with direct transcription
python direct-transcribe.py <youtube-url>
```

### Monitoring Commands
```bash
# View logs
kubectl logs -l app=youtube-video-transcriptor --tail=100 -f

# Check Pub/Sub subscription
gcloud pubsub subscriptions pull video-processing-requests-sub --auto-ack --limit=1

# List GCS files
gsutil ls -r gs://rag-widget-transcription-outputs/
gsutil ls -r gs://rag-widget-audio-chunks/

# Debug a specific message
kubectl exec -it <pod-name> -- python monitor-progress.py
```